# OAuth认证流程图 (ASCII版本)

## 🔄 完整流程时序图

```
用户点击登录按钮
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   前端 (端口3000)                           │
│  useAuth.login() → POST /api/auth/signin/google            │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   后端 (端口3001)                           │
│  1. 验证请求方法                                            │
│  2. 生成CSRF保护的state参数                                 │
│  3. 构建Google OAuth授权URL                                │
│  4. 设置state cookie                                       │
│  5. 返回授权URL                                            │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   前端 (端口3000)                           │
│  接收OAuth URL → window.location.href = redirectUrl        │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                  Google OAuth服务                           │
│  1. 显示登录页面                                            │
│  2. 用户输入Google账号密码                                  │
│  3. 显示应用授权确认页面                                    │
│  4. 用户确认授权                                            │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   后端 (端口3001)                           │
│  GET /api/auth/callback/google?code=...&state=...          │
│  1. 验证state参数防止CSRF攻击                               │
│  2. 使用授权码换取访问令牌                                  │
│  3. 使用token获取用户信息                                   │
│  4. 创建用户会话数据                                        │
│  5. 设置HttpOnly Cookie                                     │
│  6. 重定向到前端成功页面                                    │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   前端 (端口3000)                           │
│  /oauth-success?user_info=...                              │
│  1. 解析URL中的用户信息                                     │
│  2. 显示成功信息                                            │
│  3. 2秒后自动跳转首页                                       │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   首页 (端口3000)                           │
│  useAuth Hook自动检查登录状态                               │
│  GET /api/auth/user (自动调用)                              │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   后端 (端口3001)                           │
│  1. 从Cookie读取用户会话                                    │
│  2. 验证会话是否过期                                        │
│  3. 返回用户信息                                            │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   前端 (端口3000)                           │
│  1. 更新认证状态                                            │
│  2. 显示用户头像和登出按钮                                  │
│  3. 隐藏登录按钮                                            │
└─────────────────────────────────────────────────────────────┘
```

## 🏗️ 系统架构图

```
┌─────────────────────────────────────────────────────────────┐
│                        用户                                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      前端服务                               │
│                    (端口3000)                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   用户界面      │  │   状态管理      │  │   OAuth页面 │ │
│  │   (首页)        │  │   (useAuth)     │  │ (成功/错误) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                      后端服务                               │
│                    (端口3001)                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   OAuth登录     │  │   OAuth回调     │  │   用户管理  │ │
│  │   (生成URL)     │  │   (处理授权)     │  │  (会话管理) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Google OAuth服务                         │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   授权页面      │  │   令牌交换      │  │   用户信息  │ │
│  │   (用户登录)     │  │   (code→token)  │  │  (profile)  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 🔌 API接口调用图

```
┌─────────────────────────────────────────────────────────────┐
│                        前端                                 │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ 1. POST /api/auth/signin/google
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        后端                                 │
│  返回OAuth授权URL                                           │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ 2. 重定向到Google
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    Google OAuth                             │
│  用户授权后回调到后端                                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ 3. GET /api/auth/callback/google
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        后端                                 │
│  处理OAuth回调，设置Cookie                                   │
│  重定向到前端成功页面                                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ 4. 显示成功页面
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        前端                                 │
│  2秒后跳转首页                                              │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ 5. GET /api/auth/user
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        后端                                 │
│  验证Cookie，返回用户信息                                    │
└─────────────────────────────────────────────────────────────┘
                                │
                                │ 6. 更新UI状态
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                        前端                                 │
│  显示用户头像和登出按钮                                      │
└─────────────────────────────────────────────────────────────┘
```

## 🔒 安全机制图

```
┌─────────────────────────────────────────────────────────────┐
│                    CSRF保护机制                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   生成state     │  │   设置Cookie     │  │   验证state │ │
│  │   (随机字符串)   │  │   (HttpOnly)     │  │   (防攻击)  │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    会话安全机制                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   HttpOnly      │  │   Base64编码     │  │   过期时间   │ │
│  │   Cookie        │  │   (数据保护)     │  │   (自动清理) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                    环境变量保护                             │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────┐ │
│  │   .env文件      │  │   .gitignore     │  │   env.example│ │
│  │   (敏感信息)     │  │   (不提交)       │  │   (配置模板) │ │
│  └─────────────────┘  └─────────────────┘  └─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 📊 数据流图

```
用户输入 → 前端验证 → 后端处理 → Google API → 数据存储 → 状态更新 → UI渲染
   │           │          │          │          │          │          │
   ▼           ▼          ▼          ▼          ▼          ▼          ▼
登录按钮   表单验证   生成OAuth  获取用户   设置Cookie  更新状态   显示头像
   │           │          │          │          │          │          │
   ▼           ▼          ▼          ▼          ▼          ▼          ▼
useAuth   前端路由   后端路由   Google    HttpOnly    Context    React
Hook     验证     处理      OAuth     Cookie     状态      组件
```

## 🚨 错误处理流程图

```
OAuth错误发生
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   后端错误处理                               │
│  1. 捕获错误                                               │
│  2. 记录错误日志                                           │
│  3. 确定错误类型                                           │
│  4. 生成错误描述                                           │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   重定向到错误页面                           │
│  /oauth-error?error=ERROR_TYPE&error_description=DESC      │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   前端错误页面                               │
│  1. 解析错误参数                                           │
│  2. 调用错误信息API                                        │
│  3. 显示错误详情                                           │
│  4. 提供解决建议                                           │
│  5. 10秒后自动跳转首页                                     │
└─────────────────────────────────────────────────────────────┘
```

## 🔍 调试流程图

```
开发环境启动
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   前端服务 (端口3000)                        │
│  npm run dev                                               │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   后端服务 (端口3001)                        │
│  npm run dev                                               │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   测试OAuth流程                             │
│  1. 点击登录按钮                                           │
│  2. 检查网络请求                                           │
│  3. 验证重定向流程                                         │
│  4. 检查Cookie设置                                         │
│  5. 验证状态更新                                           │
└─────────────────────────────────────────────────────────────┘
        │
        ▼
┌─────────────────────────────────────────────────────────────┐
│                   常见问题排查                               │
│  1. 水合错误 → 检查国际化配置                               │
│  2. 重定向错误 → 验证Google Console配置                     │
│  3. Cookie问题 → 检查域名和设置                             │
│  4. 网络错误 → 确认服务状态                                 │
└─────────────────────────────────────────────────────────────┘
```

---

*这些流程图提供了OAuth认证系统的完整可视化表示，帮助开发者和运维人员理解系统架构和数据流。*
