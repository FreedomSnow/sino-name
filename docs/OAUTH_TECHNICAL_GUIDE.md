# OAuthæŠ€æœ¯å®ç°æŒ‡å—

## ğŸ“‹ ç›®å½•
- [æ¦‚è¿°](#æ¦‚è¿°)
- [ç³»ç»Ÿæ¶æ„](#ç³»ç»Ÿæ¶æ„)
- [æŠ€æœ¯å®ç°](#æŠ€æœ¯å®ç°)
- [APIæ¥å£](#apiæ¥å£)
- [å®‰å…¨æœºåˆ¶](#å®‰å…¨æœºåˆ¶)
- [é”™è¯¯å¤„ç†](#é”™è¯¯å¤„ç†)
- [éƒ¨ç½²é…ç½®](#éƒ¨ç½²é…ç½®)

## ğŸ¯ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†æè¿°äº†Sino Nameé¡¹ç›®Google OAuthè®¤è¯ç³»ç»Ÿçš„æŠ€æœ¯å®ç°ï¼ŒåŒ…æ‹¬æ¶æ„è®¾è®¡ã€æµç¨‹å®ç°ã€å®‰å…¨æœºåˆ¶å’Œéƒ¨ç½²é…ç½®ã€‚

### æŠ€æœ¯ç‰¹ç‚¹
- **è‡ªå®šä¹‰å®ç°**: å®Œå…¨è‡ªä¸»å®ç°çš„OAuth 2.0æµç¨‹
- **å‰åç«¯åˆ†ç¦»**: å‰ç«¯(3000ç«¯å£) + åç«¯(3001ç«¯å£)
- **å®‰å…¨ä¼˜å…ˆ**: CSRFä¿æŠ¤ã€çŠ¶æ€éªŒè¯ã€å®‰å…¨Cookie
- **ç”¨æˆ·ä½“éªŒ**: è‡ªåŠ¨çŠ¶æ€åŒæ­¥ã€æ™ºèƒ½é‡å®šå‘ã€é”™è¯¯å¤„ç†

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯      â”‚    â”‚   åç«¯      â”‚    â”‚   Google   â”‚
â”‚ (ç«¯å£3000)  â”‚â—„â”€â”€â–ºâ”‚ (ç«¯å£3001)  â”‚â—„â”€â”€â–ºâ”‚   OAuth    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç»„ä»¶æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å‰ç«¯æœåŠ¡                             â”‚
â”‚                    (ç«¯å£3000)                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   ç”¨æˆ·ç•Œé¢      â”‚  â”‚   çŠ¶æ€ç®¡ç†      â”‚  â”‚   OAuthé¡µé¢ â”‚ â”‚
â”‚  â”‚   (é¦–é¡µ)        â”‚  â”‚   (useAuth)     â”‚  â”‚ (æˆåŠŸ/é”™è¯¯) â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”„ æŠ€æœ¯å®ç°

### å®Œæ•´è®¤è¯æµç¨‹

```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯(3000)
    participant B as åç«¯(3001)
    participant G as Google OAuth

    U->>F: ç‚¹å‡»ç™»å½•æŒ‰é’®
    F->>B: POST /api/auth/signin/google
    B->>B: ç”Ÿæˆstateå‚æ•°
    B->>F: è¿”å›OAuth URL
    F->>U: é‡å®šå‘åˆ°Google
    U->>G: è¾“å…¥Googleè´¦å·å¯†ç 
    G->>U: æ˜¾ç¤ºæˆæƒç¡®è®¤é¡µé¢
    U->>G: ç¡®è®¤æˆæƒ
    G->>B: å›è°ƒ + æˆæƒç 
    B->>G: ä½¿ç”¨æˆæƒç æ¢å–token
    G->>B: è¿”å›access_token
    B->>G: ä½¿ç”¨tokenè·å–ç”¨æˆ·ä¿¡æ¯
    G->>B: è¿”å›ç”¨æˆ·ä¿¡æ¯
    B->>B: è®¾ç½®ç”¨æˆ·ä¼šè¯Cookie
    B->>F: é‡å®šå‘åˆ°æˆåŠŸé¡µé¢
    F->>F: æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
    F->>F: 2ç§’åè‡ªåŠ¨è·³è½¬é¦–é¡µ
    F->>B: GET /api/auth/user (è‡ªåŠ¨æ£€æŸ¥)
    B->>F: è¿”å›ç”¨æˆ·ä¿¡æ¯
    F->>F: æ›´æ–°UIçŠ¶æ€
    F->>F: æ˜¾ç¤ºç”¨æˆ·å¤´åƒå’Œç™»å‡ºæŒ‰é’®
```

### å®ç°ç»†èŠ‚

#### 1. çŠ¶æ€ç®¡ç† (useAuth Hook)
```typescript
export const useAuth = () => {
  const [authState, setAuthState] = useState<AuthState>({
    user: null,
    loading: true,
    error: null
  });
  const [isPending, startTransition] = useTransition();

  // å®‰å…¨çš„å¯¼èˆªå‡½æ•°
  const safeNavigate = (url: string) => {
    startTransition(() => {
      window.location.href = url;
    });
  };

  return {
    ...authState,
    login,
    logout,
    refreshUser,
    isAuthenticated: !!authState.user,
    isPending
  };
};
```

#### 2. å®‰å…¨å¯¼èˆªå®ç°
```typescript
// ä½¿ç”¨useTransitioné¿å…æ¸²æŸ“é”™è¯¯
const [isPending, startTransition] = useTransition();

const safeNavigate = (path: string) => {
  startTransition(() => {
    router.push(path);
  });
};
```

## ğŸ”Œ APIæ¥å£

### è®¤è¯æ¥å£

#### 1. ç™»å½•æ¥å£
```bash
POST /api/auth/signin/google
```
**åŠŸèƒ½**: å¯åŠ¨Google OAuthç™»å½•æµç¨‹
**è¯·æ±‚ä½“**: `{}`
**å“åº”**:
```json
{
  "success": true,
  "redirectUrl": "https://accounts.google.com/oauth/authorize?...",
  "message": "OAuthæˆæƒURLå·²ç”Ÿæˆ"
}
```

#### 2. ç”¨æˆ·ä¿¡æ¯æ¥å£
```bash
GET /api/auth/user
```
**åŠŸèƒ½**: è·å–å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯

#### 3. ç™»å‡ºæ¥å£
```bash
POST /api/auth/logout
```
**åŠŸèƒ½**: ç”¨æˆ·ç™»å‡ºï¼Œæ¸…é™¤ä¼šè¯

## ğŸ”’ å®‰å…¨æœºåˆ¶

### CSRFä¿æŠ¤
- **stateå‚æ•°**: éšæœºç”Ÿæˆçš„32ä½å­—ç¬¦ä¸²
- **Cookieå­˜å‚¨**: HttpOnly + SameSite=Lax
- **å‚æ•°éªŒè¯**: å›è°ƒæ—¶éªŒè¯stateä¸cookieæ˜¯å¦åŒ¹é…
- **è¿‡æœŸæ—¶é—´**: 10åˆ†é’Ÿè‡ªåŠ¨è¿‡æœŸ

### ä¼šè¯å®‰å…¨
- **HttpOnly Cookie**: é˜²æ­¢XSSæ”»å‡»
- **Base64ç¼–ç **: ç”¨æˆ·æ•°æ®ç¼–ç å­˜å‚¨
- **è¿‡æœŸç®¡ç†**: è‡ªåŠ¨æ¸…ç†è¿‡æœŸä¼šè¯

## ğŸš¨ é”™è¯¯å¤„ç†

### å¸¸è§é”™è¯¯åŠè§£å†³æ–¹æ¡ˆ

| é”™è¯¯ä»£ç  | é”™è¯¯æè¿° | è§£å†³æ–¹æ¡ˆ |
|----------|----------|----------|
| `invalid_grant` | æˆæƒç å·²è¿‡æœŸæˆ–æ— æ•ˆ | é‡æ–°ç™»å½• |
| `access_denied` | ç”¨æˆ·æ‹’ç»æˆæƒ | é‡æ–°æˆæƒ |
| `redirect_uri_mismatch` | é‡å®šå‘URIä¸åŒ¹é… | æ£€æŸ¥Google Consoleé…ç½® |

## âš™ï¸ éƒ¨ç½²é…ç½®

### ç¯å¢ƒå˜é‡é…ç½®
```bash
# Google OAuthé…ç½®
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret

# NextAuthé…ç½®
NEXTAUTH_URL=https://your-domain.com
NEXTAUTH_SECRET=your_nextauth_secret

# å‰ç«¯é…ç½®
FRONTEND_BASE_URL=https://your-domain.com
```

### ç”Ÿäº§ç¯å¢ƒæ³¨æ„äº‹é¡¹
1. **HTTPS**: å¿…é¡»ä½¿ç”¨HTTPSåè®®
2. **åŸŸå**: ç¡®ä¿åŸŸåé…ç½®æ­£ç¡®
3. **Cookie**: è®¾ç½®é€‚å½“çš„Cookieå®‰å…¨å±æ€§
4. **æ—¥å¿—**: å¯ç”¨é”™è¯¯æ—¥å¿—è®°å½•

## ğŸ§ª æµ‹è¯•å’Œè°ƒè¯•

### æµ‹è¯•è„šæœ¬
```bash
# æ‰§è¡Œå®Œæ•´APIæµ‹è¯•
./test-oauth-apis.sh

# æ‰‹åŠ¨æµ‹è¯•ç™»å½•
curl -X POST http://localhost:3000/api/auth/signin/google \
  -H "Content-Type: application/json" \
  -d '{}'
```

### è°ƒè¯•å·¥å…·
- **OAuthè°ƒè¯•é¡µé¢**: `/oauth-debug`
- **è®¤è¯æµ‹è¯•é¡µé¢**: `/test-auth`
- **æµè§ˆå™¨å¼€å‘è€…å·¥å…·**: Networkã€Consoleã€Applicationé¢æ¿

---

*æœ¬æ–‡æ¡£æä¾›äº†Sino-Nameé¡¹ç›®OAuthç³»ç»Ÿçš„å®Œæ•´æŠ€æœ¯å®ç°æŒ‡å—ã€‚*
